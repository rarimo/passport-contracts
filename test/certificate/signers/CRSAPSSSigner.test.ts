import { ethers } from "hardhat";
import { expect } from "chai";
import { Reverter } from "@/test/helpers/";

import { CRSAPSSSigner } from "@ethers-v6";

describe("CRSAPSSSHA2Signer", () => {
  const reverter = new Reverter();

  let signerSha2: CRSAPSSSigner;
  let signerSha512: CRSAPSSSigner;
  let signerSha384: CRSAPSSSigner;

  before("setup", async () => {
    const CRSAPSSSigner = await ethers.getContractFactory("CRSAPSSSigner");

    signerSha2 = await CRSAPSSSigner.deploy();
    signerSha512 = await CRSAPSSSigner.deploy();
    signerSha384 = await CRSAPSSSigner.deploy();

    await signerSha2.__CRSAPSSSigner_init(65537, 0);
    await signerSha512.__CRSAPSSSigner_init(65537, 1);
    await signerSha384.__CRSAPSSSigner_init(65537, 2);

    await reverter.snapshot();
  });

  afterEach(reverter.revert);

  describe("#verifyICAOSignature", () => {
    it("should verify icao signature using SHA2", async () => {
      const signedAttributes =
        "0x308203c3a003020102020874442b6b708ef7a2304106092a864886f70d01010a3034a00f300d06096086480165030402010500a11c301a06092a864886f70d010108300d06096086480165030402010500a203020120302f310b3009060355040613025048310c300a060355040a0c034446413112301006035504030c09435343413031303037301e170d3232313231323136303030305a170d3333303430313135353935395a302d310b3009060355040613025048310c300a060355040a13034446413110300e060355040313074453303131313330820122300d06092a864886f70d01010105000382010f003082010a0282010100ab630b320a41ecf8886a904ab50fabcfad658f5af8a9f8aaecefe0dc5e2ea99eba3deccba3f58885f8574fe0ad5c889763afc2b68e66b5928403d508724ad1e7fd05c573c053e04660fd31128cff2e2f574ec92430202f5dafa6df66b46fb16ece1372424d3aa3b975428c59f18fe1f32e6c328b64f58f95e05684dfff2d21a85cb73bcb32ac172c8f782fa2ea942118379833bec37cab64de493ddae79014ed0e6fcaa2ca4cdc3bdb0442ba550cde8355194c3c3934b2d8bfa513fcf5788c0569e0527cd20daa5e8e114204661a3d1f21650d01703e7a112602cf8fbefbc329afc18d3d49a68b60e5c89c5152ad6e7f0480b0e4157b26640c569ae477e04f190203010001a38201c7308201c3300e0603551d0f0101ff040403020780301d0603551d0e04160414363257ff5b20debaa6e26c257d3ebb4fa1e7bcf5305e0603551d23045730558014a1436db84f1c134e49b387da56cee801102d4f73a133a431302f310b3009060355040613025048310c300a060355040a0c034446413112301006035504030c0943534341303130303782086b8a5f2f46fa934b302b0603551d1004243022800f32303232313231323136303030305a810f32303233303430313135353935395a30390603551d1104323030811c70617373706f72742e6469726563746f72406466612e676f762e7068a410300e310c300a06035504070c0350484c30390603551d1204323030811c70617373706f72742e6469726563746f72406466612e676f762e7068a410300e310c300a06035504070c0350484c306d0603551d1f046630643030a02ea02c862a68747470733a2f2f706b64646f776e6c6f6164312e6963616f2e696e742f43524c732f50484c2e63726c3030a02ea02c862a68747470733a2f2f706b64646f776e6c6f6164322e6963616f2e696e742f43524c732f50484c2e63726c3020060767810801010602041530131301501302504f130250441302505213025053";
      const icaoMemberSignature =
        "0x875ef62f6832599f41b50ca51a478c92ff47b61f2090157f64b425b1e1ad5612e6abb7d5808d9be5f0eaaa16d2b516ef161534c78d542ffd659107535c2bab643163fb9af27a50389792508d1cdbda347a103404c5e08d2d97c7935994631d42fe7e0caa892dc3ec39d3ac94dbccb3cd0870b21b9c836feed5bc32e9ec6830392bdade1fc9b5280fbaa2ceaa78d9524af3d015cbaf07eebc84a9caec81a4407452573a101b79772056193d207a8398690ed0dd0cc5a6410fd844d313c50934d6e1d556f8e7b39b12525f3cd766c9342fbd892e40408b0c232d888da11fc64d0f09db70971d395d7a1d2aacfe9da78e3c46ce43b3ce5b9fc1e6a90c065cdafa2e8a117d63c00cf9f54e3a3313789f03dd7efc76641c2cf5068ca4512c82fa6c62f6bd36b12523dc46f444b8312d2f6e6ec22cd10eddb19220d9b8ba4cc442dd836335482c6309d56e87492d2fdaefdb7b5ede566ed43eb87955451225846ce2535b803a9ca79034cc3aa41307cc57f0962cb8b2c3b99a5c87150387f7d8de6a18f6a838404c4aa5bb279378fb285c096d4c2664c700ac4e3c0cb44f920928e764dd4b10f22d3cb5bdfac78066b1b0a5ae75528e447b262510d41150a94ab0f645cc61ae99a3719bd29cf3901dde6de7cc162051f34c642a0f7854ef00d4143d755ad72bc71371c3a8dedb94118272f37f853bd171743b0c7a9a8cb96095476c9c";
      const icaoMemberKey =
        "0xd24081be6cc14fe3fb4b35ab6df1a7f28f373017ef15a26b67ff2dd04773a3ef8942b7ba5f2f91aea469fe757e2e3362a907610b441f3610f528b1f39739a132c4bebc26c37d25b6d12481336fecddfc6bdcd011be4f2912ff0663cb70d9938280813dd3f32f2e6fef184881f784bbd2fd2d165b169d8594c45d832dbaebfdcb532d6542b57413825df5164b577dcdc248dfc4a8b071eb0bef021128e9172b77a18a5a6b00ebc0e07af0a9df6592684805a4ba0db00dddaabf793641ec0da51aecc6160acd56a0194d1161271b8feaaf0ae851ae65f1464c79607bbb237de3dbd0a299e9cda846c362976108d10555b57866a56c87c6a5d92d1888d6260fa90459afb14688b8a53921d2d477d1677518956412e01eb2592b27ad62a3d3a50777c4bee3f348b4788bb7bbd38d6bd902968a7b3640d75f98b78824ee9462e1b2d405b8c1ce7d7dbef479c2979553790b7d7fa8a6f05dad4cf95b92a218b410eb5b9df712d099b6952a07f122d21e95b934e9a765e758397b191fd01c0c4ae669039a0d7003308ab78d03809752bb7b676c3f3bbd9ac4b8cf0162efb50e01c52e3a97fed31d1e73f12b3da7b4df87fd7e93f70f92dc154d0bcef5a39c9631b2b50c7c7b91f4a63d4e3d487c37fc63bbdf87b71cad5581409661d15f77ff738a4d53d23424d999490607ebfd8293b2fb5c269cd8a19477ca88f6f7cb1abe00fb16c9";

      expect(await signerSha2.verifyICAOSignature(signedAttributes, icaoMemberSignature, icaoMemberKey)).to.be.true;
    });

    it("should verify icao signature using SHA512", async () => {
      const signedAttributes =
        "0x308203c9a003020102020401000011304106092a864886f70d01010a3034a00f300d06096086480165030402030500a11c301a06092a864886f70d010108300d06096086480165030402030500a203020140305d311a301806035504030c11637363612d6d6f6e74656e6567726f2d32311d301b060355040b0c144d696e6973747279206f6620496e746572696f7231133011060355040a0c0a4d6f6e74656e6567726f310b3009060355040613024d45301e170d3233313031333032303030305a170d3334303131333032303030305a3066310b3009060355040613024d4531133011060355040a130a4d6f6e74656e6567726f311d301b060355040b13144d696e6973747279206f6620496e746572696f72312330210603550403131a64732d312d6d6f6e74656e6567726f2d323032302d51342d303130820122300d06092a864886f70d01010105000382010f003082010a0282010100966b5855b11429c43dbfa9a0c51b1e56004ffd90c94995442227f4f41a63bf08ddbb89e201be08852c35ee9bc4c4c84537253a3092e00536582d85c158b37c730cc37b610de26f1a1ac156abe8c0fd0f88cab63f25560b53110250900dbdbaf7d3a3a81826b9cec1c140e87aa3e8e821cd52b2fc02b57117b8b2df99db91c9bbd4b8dd517f0a4e46faf718b7ea63eb99927fb883bd642fd23c71e04c0463e03ad2fb37e5bd6439ba7219ce55afe4d5e3eb7e848de571c997c4e3c50e1f54287a92325c0d716399ac624c57f2852d2c7a5f6e80bc024a932dd3e5b08ba4a885bf94159fd0b7a78483b5ef22e1d923f432436fc0b00e2e562fd10239f46c736a1b0203010001a382016a30820166302b0603551d1004243022800f32303233313031333032303030305a810f32303234303131333032303030305a30480603551d110441303f810f63736361406d75702e676f762e6d65861a687474703a2f2f7777772e637363612e6d75702e676f762e6d65a410300e310c300a06035504070c034d4e4530480603551d120441303f810f63736361406d75702e676f762e6d65861a687474703a2f2f7777772e637363612e6d75702e676f762e6d65a410300e310c300a06035504070c034d4e45300e0603551d0f0101ff040403020780301f0603551d230418301680149b1e9a5967c799bedaacf0e9db21939a40678061301d0603551d0e04160414ae5f18361e06a508f9293ed0a2d3890be79f410630380603551d1f0431302f302da02ba0298627687474703a2f2f7777772e637363612e6d75702e676f762e6d652f43524c732f4d4e452e63726c3019060767810801010602040e300c020100310713015013024944";
      const icaoMemberSignature =
        "0x47f32a6590002f1c38b9b47439d51deeddbb591abd2958e4d5be34581499f7aec26f1286a68b055a3f224ac6c8f903d4dd4b74d6058921d5c6a7fbfec59976d18909835e703762d6534876a257beceb05b281148b7c8a326de5c1e2200d159f6a2b1e7be4878237e3840debc48f63cefe36a9122dd2328d8fe0b7dfaf950b7568abdcae1a17a134addc5662d02df208dc3b7fee797f42a3fe83922fa1f9cc2e73d4bc84f05a9c9cf04ae266b51513dc63be2bf99d31415153a810413bfa2afcb405fd7f49a65915c91b7b205c461fcfff85b53847fe03dab29746b9214155987c2854e648c82f1b495205feb41d7368677a727fc38e64245b7c6c2a72d2efe0e92edd1295484b20165e48fbb7ea091dd78c207703a05368b6c336c42eef8a23a0d5c42db47897240f4f3c082f8c212a1bba93b88593660ba8a698d2d1ed0fc8fd438bc11b22c05f53b236d954aa69722be68353ef81373625ab168c33df79a1bd26d1475bf1aa7ecc3fba9b080c3827a2bbdddb0328a66230a9d763c42ec4c50d66d5654a42ce1daa1606683e2c29a1819a737e188f73ebcf3263f63525be672cf4a787b8606a6da3c0dcabf6c07549a7c41064a0093642f0e89a1d2aa5aa2d7deaf806c0fd214e86672750165ae962828fc7e2c66c7bd7e58dc9e3e43db3ff3cb1b463bd25a05ac626678048b701640678b6aba52da6e8029f4b6af7c45c08c";
      const icaoMemberKey =
        "0xba08f94da862bf155307131aacf5e465251eb3af49d4057db1ebef96107391df8062291d57f182d295076e2b3468b8504d1c5d1982564a078bf06951e04e88f4c302ec1cf058e29b942a6cd58316734e4096e397716e70b83b229ad8f74d7222c6b298e0548f8b6392117ff77425754dcf0ad15d68370810f5fa4e5ab62f3cc11ea488a9fed336c5a1156a5a763aad6e373192b85419d9728e1bafa1c489ca2e0e3368faf932a643e29f814c34f4500c5b8ffd80be0d2c30fa2a6cdc5842a0e7084fc75684e1f9c462b552e9cf0731b9f63f45866d6ae35f66a68be0ff3dd600f67917f3053459e771d52f40d11daf5dcfa5223edb0832f658f676098c2d871bc5cc2522f555bcba81546efed66ab1bb27504e7cada9d3ed60c4a28d07229304aad3a97f7479c27057afa8d82f546b3f7b7150d8c2400efa504652ac0e2ec3de3193a1d0de74531c028e820999996ee864ecb8582e990847153eff236eb9b85d53e3445f937b48832f2d5a65d6d18ebe8c99d0a108c5c493775b948bd44c264fdd0d70df09ff0d0fe52c156494939b9a70f853feee8785b90cb0c5f21d252018131512b3deb54b8db14f365ddb9aa1c51075dd98d4ad74ffc9fed59567d07e9bac761a2424462556119e41404d871ac723e9d1aa2ac4726f6131f0ca04feb813214c8081383cbcbb18bc235828761fc31d79acb42cc6d1098ae5c264bde40a19";

      expect(await signerSha512.verifyICAOSignature(signedAttributes, icaoMemberSignature, icaoMemberKey)).to.be.true;
    });

    it("should verify icao signature using SHA384", async () => {
      const signedAttributes =
        "0x3082047ba003020102020463ce64b7304106092a864886f70d01010a3034a00f300d06096086480165030402020500a11c301a06092a864886f70d010108300d06096086480165030402020500a2030201303065311f301d06035504030c164555204c61697373657a20506173736572204353434131173015060355040a0c0e4575726f7065616e20556e696f6e311c301a060355040b0c134575726f7065616e20436f6d6d697373696f6e310b3009060355040613024555301e170d3233303133303030303030305a170d3239303433303030303030305a3063311d301b06035504030c144555204c61697373657a2050617373657220445331173015060355040a0c0e4575726f7065616e20556e696f6e311c301a060355040b0c134575726f7065616e20436f6d6d697373696f6e310b300906035504061302455530820122300d06092a864886f70d01010105000382010f003082010a0282010100b0bc4b47bc63fe1324717e8564ebd9075cc3f9d69fd3b562719ddaf0c96a2848a0820120caaebb5a7d3379bfae05aa420b909d3814525a5cdb88eb01a12b44bb776ffb85f4be5d58e2e0bc6eb624bdf350cb840849153077fb56ed97506cd567b50a93bc77a1bcb1ba1d91453683ac272b81595ba8921bfb07fafaf7973567f3d2b4f04656b09e431894ed9bb97dd92f769d635514f8a50470836ee088927dcde6b5a3812bf2093884a89a48510cc3ff6110af13dfc950a471eff8ab142366ec0ce75631ba8fb2480ff1ddf150d6ad145e23614ee200702d2f68705875eb4bb3548ade6a5e6c219f4658a5699a5d607f5a5b28be0cd706f6251c2181f5f6c7bd0203010001a3820217308202133081920603551d2304818a308187801445728821c8fbff1153455807ad09ed5e868035e8a169a4673065311f301d06035504030c164555204c61697373657a20506173736572204353434131173015060355040a0c0e4575726f7065616e20556e696f6e311c301a060355040b0c134575726f7065616e20436f6d6d697373696f6e310b300906035504061302455582045f1ea223301d0603551d0e04160414230d61b5ac435ba5fc76ab8aa8e8480ebf56f6ef300e0603551d0f0101ff040403020780302b0603551d1004243022800f32303233303133303030303030305a810f32303233303433303030303030305a302f0603551d1104283026811265752d64734065632e6575726f70612e6575a410300e310c300a06035504070c0345554530310603551d12042a3028811465752d637363614065632e6575726f70612e6575a410300e310c300a06035504070c034555453081a30603551d1f04819b3081983032a030a02e862c68747470733a2f2f65752d637363612e6a72632e65632e6575726f70612e65752f63757272656e742e63726c3030a02ea02c862a68747470733a2f2f706b64646f776e6c6f6164312e6963616f2e696e742f43524c732f4555452e63726c3030a02ea02c862a68747470733a2f2f706b64646f776e6c6f6164322e6963616f2e696e742f43524c732f4555452e63726c3016060767810801010602040b300902010031041302504c";
      const icaoMemberSignature =
        "0x6e8e785cf66088e0753cdf8b423d915a19162cb8887a62e007668d0e9ffeab2c2e24e0a0eb49cf6a07095e92d2905db0c253bfd81eaac7cefd69f7cf6331f1baa983ed1648be3b26ec647a703736e06b4ad8dec71996cf956d80a2787ad037eed49d48ea9089a7607b6db95fb14145994e45df8ccb5c9fb4dd8bec98e37c25b10d56a847da0f4a0880c5a639d54279b6a62e2b69939d86f992adabd604df875d2e7d1c55c035210fb295bf5ef70acb9fa4f2e6236220388aa5037197259b3fcf9a7f567528373aa0ba9379abc092ae0cae66fa1a936c41556367b38775762d248804d92faaf934a651fbe06588c5ff9e8e967e40483623defff1f07004b9439bfe18249ce22304f1458bd6b2e3f9664a350a0aad2fb96447fa4b2961735b97d40e17f5ec1184501fc00c3cb419c386b153fc6ea75d78df6625706c869c582f0848cedb9a9b8f62f652b73fdfd4ef57c93cbcb383dae85368afc43035952564c15030d6fab4e4a10e148acf5c6b8e87c45e438edf783ce8d0208d1a477998a1072f6d6db5bb9074561f48fe6d82cd81a2a1e64db0c5eb098360a92189fa0d17c003d86b41a970555f68b51f82bfea882ef9dbebf1e096e966eef300ac7c5455207d4f234f6b0a73986a11e767ce6e6258092e00068e2c5d1d5c2bbf05aec3107eea2b8ca7f96cfd428d0b4af55db650959c4063830256ef030989560bce2e41d8";
      const icaoMemberKey =
        "0xc516b27aa9cd9c08245199108217202d2139ab3c9419d65ab6e99e08a888852f6e170c76deaaa04adc88238bacb9e253ab95d9fcad9fe710e8ca0bd6822b2c33fd93777e1a6ac7724b49f2d6860474ae71ca992fc7c8b301b3561d5c3effe29aa536e24d6f25c5e2f9b7a80035917dcf6e58e4c405c104f373f69df6e747ca230b1058089bb7de27f824e67af4651ca77499735b8c378a06f4ddd567918ec021e899b908546ac23bdcaa52f96eb6931df76f7620e9ccc87110be0cc2839d88d9084742d9b7045285fd7bd24a6421f500c69639218808ad24d3f7e1634aaddfab6c9c9c46f539fa154f3f49ca446dd4a6bb589875ee8ce226f073d6242ff492e2810a34afd5193afc3ba94891d86ce1b87852fc0bd7317207a3852fe5889e81d61a923786a9c6a9b2946886a69223f0850f78797a5e79f98a63ab30f2fc23115e23f543994dab9c391e563ee868dd6343f611bc029f27b4b2188d36a910ba058d00447d1fcfbc88317a1ff08f210ac49c48c54612d8884484e8dd71688b238297b8503c343849301b357f7859605294d315a072cf3fe49dfc2fc7c1326da8325df043c740bd80f5f606b3620d459e33c3c7ecf0d083719b581cb1c93d898443e381d07d00e590d8f2f5174bb7463a850cf5152a261f999d226af7ca379e02303d3d78ce2a8520fb350f4969779f327e2fedac5c1151cd3f506f5c92bc242f0f59";

      expect(await signerSha384.verifyICAOSignature(signedAttributes, icaoMemberSignature, icaoMemberKey)).to.be.true;
    });
  });
});

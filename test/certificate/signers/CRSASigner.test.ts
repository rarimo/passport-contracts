import { ethers } from "hardhat";
import { expect } from "chai";
import { Reverter } from "@/test/helpers/";

import { CRSASigner } from "@ethers-v6";

describe("CRSASHA2Signer", () => {
  const reverter = new Reverter();

  let signerSha1: CRSASigner;
  let signerSha2: CRSASigner;
  let signerSha512: CRSASigner;

  before("setup", async () => {
    const CRSASigner = await ethers.getContractFactory("CRSASigner");

    signerSha1 = await CRSASigner.deploy();
    signerSha2 = await CRSASigner.deploy();
    signerSha512 = await CRSASigner.deploy();

    await signerSha1.__CRSASigner_init(65537, 0);
    await signerSha2.__CRSASigner_init(65537, 1);
    await signerSha512.__CRSASigner_init(65537, 2);

    await reverter.snapshot();
  });

  afterEach(reverter.revert);

  describe("#verifyICAOSignature", () => {
    it("should verify icao signature using SHA1", async () => {
      const signedAttributes =
        "0x308203a0a003020102021428f278ff051bd7ac76ae704d71c6385161bc9a35300d06092a864886f70d01010505003075310b3009060355040613024b5a311f301d060355040a131652657075626c6963206f66204b617a616b687374616e311b3019060355040b131265446f63756d656e747320616e6420654944312830260603550403131f436572746966696361746520417574686f72697479204f66666c696e652d31301e170d3232303932393036343632335a170d3332313232383036343632335a306a310b3009060355040613024b5a311f301d060355040a131652657075626c6963206f66204b617a616b687374616e31133011060355040b130a65446f63756d656e7473312530230603550403131c4d696e6973747279206f6620496e7465726e616c204166666169727330820122300d06092a864886f70d01010105000382010f003082010a0282010100bba93fd88247bfcb7ae63615a00441532c1c973fc26c5f513e7e69206125e02bcedf7d0e93618138ada7435dd97f73c29b41590bcb1ee5e26a3ff9f5e03c911c8ef4969316ebacba668932b92d760ed3e89222a8d575166edb3ff2468cc75d3ae6359d5e700cd9c1a0e3c0a8086ae70fd5a8d61e6cd71a5977e9509e95a39a8f051487e21ccd95fab72a19f61a1cbaf3a895e33bc180f264f2322faa3c69290b83fdae532608719cf85b6b754cb5661972aeaf3749c96413f38cd893ddc54b78a333c1802c5a18ee951656b7092665093b4f0021804881fa12d3c6c69cd77a7c24a8f83ea602e40bff5b5d4a10ae1c2dbc9c2614044ef71e9c5c21ee4152e3ef0203010001a382014930820145300e0603551d0f0101ff040403020780301d0603551d0e04160414a8f278ff051bd7ac76ae704d71c6385161bc9a353081b20603551d230481aa3081a78014803107b82802803c148769e4db61f762a0e9e44fa179a4773075310b3009060355040613024b5a311f301d060355040a131652657075626c6963206f66204b617a616b687374616e311b3019060355040b131265446f63756d656e747320616e6420654944312830260603550403131f436572746966696361746520417574686f72697479204f66666c696e652d3182147f3107b82802803c148769e4db61f762a0e9e44f305f0603551d2004583056305406072a830e030302013049304706082b06010505070201163b687474703a2f2f7777772e706b692e676f762e6b7a2f646f63732f6570617373706f72745f63657274696669636174655f706f6c6963792e646f63";

      const icaoMemberSignature =
        "0x810d09eba6461ff396ed3b48011430a6a0417acb4d411b4ae2d0ce5da8db4665d3cd8dedd8d705731a6f162db2268a271c5297544be66816c11ef492c7cdbec779a2eb0fb908679c269ee686c214d230acfc64c7d98026af1cd16d03d1c3c7c95af580a6921da5cff2bad33e58da2e420c477ec60b2087114eb220d7178299c05301f2c8f90610e02b81ba9151f884f819cc11468075f0597071953cf544982e7a677f393216b9713a38ffc8605d1f69a6bb5a49063f0bf75c5a142a6ea686629016c5ca36a871ed7f27c2fc9166c1fde9d382cd32ae1d95c36cacf03fe6faa98384e8a11a9b90edcd35529d389b93a2aa1dd3672aaa859a617c763e4721110ff0e4693b618dcc83752b84ecdddbee52819509d06b7bff314927956a5fc9b1f121629b14218ddc8f71c2de74761cc02fb4f5f25186e3efcb11e67912f4d22c345421cfe3d2bfacd82bfee3cea823f69671d44c51daf49465658f7492c2cc55aa424a7b8760bb9367012e7651c2412232e027a4909f708535dd4085eb2483751aee24d41ac86fc97e9f34897c1947f2a3912d3a585dee4a8ac2d45fedeb5907f26eac93b555c031a725d26cd4e099fd53d30d01f238f898e6b0494049b2294d5eb8f2f978812378e3275007666b60847e6c3c0497b36cb33b90751b496e85d1ee7e4cb6d6c7bbd1fd8e554d71f0e4943fb73ff173301f945eee5a81bdd0eee8da";

      const icaoMemberKey =
        "0xb5a1f5550e4d4e21ed4e453e97f25345d54df5e706881f99d1b1460201829749e0b0055a709ed16b99a87c457a8e81697c3888f281e64d0628241408e5614f857839d5db13a0551e85189dcd61e8241c44f764c65887efe00c0b5cec271460d0ce4310f9846fd173fd902f7aa532c2e8b662c375f1e7e45bcb243264a3b7b5ea9de2ba6c3258907b22c7e51a93c2b2c2628fffba577e12acb61dd6ef29fe89f14a0ecf0b7561e4a398415019dc5372dc5d2aa51426ddd929992d194e90b97279dc4843148f8d29f0131af495c6467f7e7bfc5bb61e00adbbe0fc40d05f29d07a9a381080b92fda548c9a12ece4a9258cdd7c662b93eb46a6bc3c4f2afe93583e8206333afe62d6760146dab3e8919336a0dab4a6b1afba115d1b396a7a1f6110f3099b2794e8c1ba7d02e9c8cdb5292997bef42ec1b3d2e3115fa36381b81165e5b5b7a28a0ba597466c90f34c00772f39cdb84e5f452bee20ac3518d71858092859f6b2db552ab6e832b584ed593b873cf58d2566fe9d92f86eda1c0d0c01519ae9141917efc0d50d959d0a5b9549d42718b011e424bc3b40d7ef8d2359cb24b93212d610cd83db96bbe177d188d3f294dcf9d3b9616b836e6ef306d950e9de92bf0bb864626e7ac39e3d98176b9a89ffb6ae8ba42f953d3a14a1c049dc8448600045d88e0df68e2c4213e2660fa5f4aba7fb059de2e6b0c4d1cca0aa3f94f1";

      expect(await signerSha1.verifyICAOSignature(signedAttributes, icaoMemberSignature, icaoMemberKey)).to.be.true;
    });

    it("should verify icao signature using SHA2", async () => {
      const signedAttributes =
        "0x30820584a00302010202097a1b6c194ef9472494300d06092a864886f70d01010b0500306c310b3009060355040613024d453117301506035504610c0e5641544d452d3032303136303130312a3028060355040a0c214d696e69737461727374766f20756e75747261c5a16e6a696820706f736c6f76613118301606035504030c0f4d4e452065494420526f6f74204341301e170d3230303331323135323631345a170d3430303631323134323631345a3068310b3009060355040613024d453117301506035504610c0e5641544d452d3032303136303130312a3028060355040a0c214d696e69737461727374766f20756e75747261c5a16e6a696820706f736c6f76613114301206035504030c0b4d4e452065494420434131308201a2300d06092a864886f70d01010105000382018f003082018a0282018100a4f8d01ed6ec94453796c35ff993a1f12d2c757a146b986a31664e5a742d388cbadfe9d031746d705d338e9faeefd3ac3e81156536345d62a880395317ac795c91cc547c3dcd329bbe21640e14a54d2e1dc7af7ae1959e23ae505d46f1b156dcd36f8d620dc60b9b3cc79be64c16d21e138c9e82896b9c20e905c90135eb60c7acff8646530dd2b9e2c16f5860a4773badff5dbf3667ec839e8368a3e87d149bef8eb7a3f04cfa46fc6502f2c50994fffc580b38c9ca1ba85adea52d5dcc50ff33d2d6a80bb1c1395ae5446c77c2405e6d3df043ff9fa30d38f8e12f2434284249acb6037f63c1d85a8d56ef58240859da1c3bca508652fe0fa039ed4b147161e53abb2ca0c9055e13e23d6195f58a4178a32257b86c26243fa5520ec05417e92990bd6affffced1b02d0bb28144625828a70227fa0ff1e7c1cc2098aae324f368bc584a72e8253de9b459280e9a576e5f770095465cae9fb8e6f2c3babeb32bbd7bd79839921a24ac1f0eb6a45f456004313b5e5ec5f1f9753dff8d6ba4309b0203010001a38202c3308202bf30120603551d130101ff040830060101ff020100300e0603551d0f0101ff040403020106301f0603551d230418301680147798362515c7a2379ebb76e7c5c97ce7f9e5eb41301d0603551d0e04160414be39265a35611589cf302f8d21c3ced8b1b827e23081e90603551d1f0481e13081de3081dba081d8a081d58681a76c6461703a2f2f6c6461702e656c6b2e676f762e6d652f434e3d4d4e45253230654944253230526f6f7425323043412c4f3d4d696e69737461727374766f253230756e757472612563352561316e6a6968253230706f736c6f76612c6f7267616e697a6174696f6e4964656e7469666965723d5641544d452d30323031363031302c433d4d453f63657274696669636174655265766f636174696f6e4c6973743b62696e6172798629687474703a2f2f63612e656c6b2e676f762e6d652f63726c2f4d4e45654944526f6f7443412e63726c3082012c06082b060105050701010482011e3082011a3081a806082b0601050507300286819b6c6461703a2f2f6c6461702e656c6b2e676f762e6d652f434e3d4d4e45253230654944253230526f6f7425323043412c4f3d4d696e69737461727374766f253230756e757472612563352561316e6a6968253230706f736c6f76612c6f7267616e697a6174696f6e4964656e7469666965723d5641544d452d30323031363031302c433d4d453f634143657274696669636174653b62696e617279303806082b06010505073002862c687474703a2f2f63612e656c6b2e676f762e6d652f6361636572742f4d4e45654944526f6f7443412e636572303306082b060105050730018627687474703a2f2f6f6373702e656c6b2e676f762e6d652f4d4e45654944526f6f7443414f435350303d0603551d200436303430320604551d2000302a302806082b06010505070201161c68747470733a2f2f63612e656c6b2e676f762e6d652f63706370732f";
      const icaoMemberSignature =
        "0x596eda7b8cad1a9352ed069f1704c838d8cb252b8aa75aa3452acde553270afd835644f382b8d76fd1c734610fb8f88e091b80ac9e3f7e4eb261c325f544d72e4dadac52d482feb4e3dbe84482db33c9e11225e4b2f413408d8d1b9640efa27b135e3dfb5513799199ebd2b1460b10a99b1a9cd593d8af3f5bc39909b4a6691531f5009f07cec1c8abb01a82df377e5929ed31151af9b668978786baa9b4c344491913b91dd54f2a32d3400b4ab62c18c29b4baf64fb87bd6deb7fcf3b6c2962a6ae2eeacab5709c74b71a20ebf46169a1b962e2d4c2eaf6370006193951d6b0b3c3089bd869504e6678e9778f1454bc889b834de76b4eb41bebdbaf3593de4f63dab79ce8b37b862b13e3fc43709d4f557a916539597d8a77f6a2a3a672cb686f3ba2757c5ac88f26d04ade3bf54f23c59aa152d25dba4bad1f2b23ef801e30f3815f6d6204ad4ae9a94ace7860de5642f8baa09d3ce8ba3355367ece681383f162cf04b76051a0cb09e4b16d858978027426f479b01f3921cb6fc3ab6e5c5e";
      const icaoMemberKey =
        "0xb182c2d29ea6bde39b2e6ae1cb6c6676cca8d76f52809a2b1cbec9006e3c946246667589da122342ed7a816322041c218f85ffe609356a07a258f6183bec271ddc6ee5a612a58631a99c9e6000b65e68e7f247bb741b33b81a4f464662a62d025fb75ef61e038be308f4dda4433fddd85dde33bcc8489d7bad4ecfb7953e93ce1189a50f5c5500ba1ea7388dfd5c200a00c499553d72389e806126c16433632639808f21482b6f4ad7ac8ec2f67cef4bfd9c96fa57eb865135400ce675071a473f3c76f7316f668896fc84edd18525696dc2a75ca409cd98ec26a19f73ae93235e2027db8c7d6cf93ea53f54fd3273be131dad4f446bbf07c1f99b4c44047caaa6101baa803c1f4c0d24e6577833c7ebe9a31f9e14d4ae57b0fa98fbb7ead6dc68c5c4294fd9289221ff51ae4f08e7ba40e819595d120dcabac18921f97a88d341b02cb519c1d6a691878f4fa13e753f223651803d96676d05af3c711192b20f4cf7cf6a79b5043f74e5d30f1891453bfcccf5ccc3fdd13b2404ca17a6df4c43";

      expect(await signerSha2.verifyICAOSignature(signedAttributes, icaoMemberSignature, icaoMemberKey)).to.be.true;
    });

    it("should verify icao signature using SHA512", async () => {
      const signedAttributes =
        "0x30820484a003020102021439bd3ee14244aceba0150380b73f970b810dfc45300d06092a864886f70d01010d05003081883125302306035504030c1c45434e20446f63756d656e746f732064652056696167656d20303037311d301b060355040b0c144943414f204d52544420504b49202d204353434131333031060355040a0c2a52657075626c69636120506f7274756775657361202d20506f72747567756573652052657075626c6963310b3009060355040613025054301e170d3234303731303133353334345a170d3239313130363133353334335a308182310b300906035504061302505431333031060355040a0c2a52657075626c69636120506f7274756775657361202d20506f72747567756573652052657075626c696331263024060355040b0c1d4943414f204d52544420504b49202d20652d50617373706f72742044533116301406035504030c0d4543442050455030303031323530820222300d06092a864886f70d01010105000382020f003082020a02820201008f3644aebf531d639ba289d832624d8e7aac3ffee175a2226ee6ec8740c0b36de596d3b0a03d2adf4321e5745cdd03966a4ea45e4690f513e1f9d545c4e56ac6aae4f6b154fe2ba81f13b4cf019b3b14c0dd5be571bc5ffb72c1fbb324e09d7ade0ce48b7cda783c812949ef92b1f6d7cbfa7faf2d209a9e15a875c2a1238cc8661a83c849912b5884b4315f78d4801ee30d48633a31221b76b261e9cd8805a20f5210e0c2c6393cc6dd7493629b47b5aa4cb48a1f47c005e639cbb449b031789f46b1fa641349dc21af52ed141563392306b0fbb007876d4aa7e9e23365f909cdf5b8faba950695155e466b00c840ba1b3dec7e9ad33106aad193304b2c8c8e8301a6dc8e2964c47b77f47aa0d6edb3c18b630c5a8513413d63486dca6d8a11fa5677f66c73bd83e4d94919f4fc88c022acd9c453e0cd613d35ff746839143adbd230bbcce6ae31ce7bc8ba6feda531ebb109bde5a7f6744f1dbd702c1b9be154004ce04dd97543f8c11de6ec8fa2c59372a7d4a891e2fe1af2931534716847ce4ac6dfb113f40f1e20db5afb8922c8f3ceafdff17dceecd66eba3a7583daa73517f414ee8a227c8e18d0a1713237a55233238a48861037d699f60a4316fc52ff839f4181c9aee194301063a17e4f3743e764be121dde40acb3c767bffefdf8d10b5a66e38a526163e667c1520262bce99e19512559fb1371732dc382c089210203010001a38201003081fd3015060767810801010602040a30080201003103130150301f0603551d23041830168014ab9902010e20d7a5d255aa50a7152b4ce77b785b301b0603551d1204143012a410300e310c300a06035504070c03505254301b0603551d1104143012a410300e310c300a06035504070c03505254302d0603551d1f042630243022a020a01e861c687474703a2f2f7777772e7065702e70742f65636e3030372e63726c301d0603551d0e041604149039b39b4bdc2e3058354eb3cf15580a1d72dcb3302b0603551d1004243022800f32303234303731303133353334345a810f32303234313030383133353334345a300e0603551d0f0101ff040403020780";
      const icaoMemberSignature =
        "0x1bae4da9d23f53c9581962b64b05f415fb1fa494b702b526e9ca3cc93dd69c276b0fab7ea8ff7676661b194b19479cf2399efd94e169f6cfa7a9b2e849ea6036daa72010d9e5ee475cc864de05f8dab6e9731e5c63e76f89b430466a6c7fcf77665f20810e626c32f707ca405f312c1fc626dab6c8afba4c1e5364bd5f2da1076d5fb32274d284867f6fd86e4fa7e89063e20dd547e6276e6a256700c355267e4e6d9b7eb772fbd4132a5489e51bed5db334c850e9246eed7649dc4712e10c79ee7812f11cb890069ae7057e01898014412ff70487422edd15257f0f4139856357c087cd8feee10353267a44f9b09f89c52ce80d818009e4a163d2159b55b00bd816d92b707a2a84d82c9ead0fd45d698e6535a088a7e723b57b89df1975dd2a05876d40a98c4d2fdfd5b9f593cbc6cdd3aed7be73505f53413734e4364f0ef60885feb0bce7416da0025eb9172974e1a3f0c4e524a3ac5cdefa88b25aa743669066cd52112c76d248ddd7f183105e5ed784b29b4a1cd76ad278c9fb69cd6b392f4ab3716928a0033e2480f868f14bc23fa8ddfd27ab6686ba43067972f6a71c3970d03dc449f98c1fc2a3e89c666ee8f75f72334d15f4085319da4b006a7de53f5f09d68bff97eaf1b032855bb627c0229daf68938a2dcd7ade0026601314d557a4a3d103b58bd47300f75093fa195e6122cdf9249e4686d9d120b24c41cdb0";
      const icaoMemberKey =
        "0xa3632f7ee02b38b51677d3120de9ea21408d4208ce61c8731ef17e4ca40651be96ef9dd48203adcc0613262549e79675084597670f56eb869553a4144038fbe1f51588cd84563860dad70c0cce40cf73cc744d5948898058f3933c14812dcc0a0ee64b8d33c03c5487c17e62d4c8dee68e21854e6c0aa4193413ff9e9ed4778d1df4eb8c5afc7103a678439b45672ef7071f16567a4789e59c84719364acc790c840898f21d7356564597962981a9cd9448986e87a79704c8d602fcbd54dacdb12771e72e8f2d6427fda4a95b4af3aad7d5a46b798251bccaee7c3a56da6bd69b723697301d179c050818c65d9d7c1eb0daff57c7613d151cd22006c328d72e0fcca820e665f08bba199690027373e606303bd771e60c36435c3163f65c3051b6d3f012719bdad6ca45f85f6c18acd6e266b2c32877c9c409bd9545977e9f2e6e8c39b42be616b849a17344f274a59dab4e91b59b2d3d1cd6f4c06563af443bbf93dd5febc6c98a99c2315339ffdf0e635344aa06cd9a88a317070e19c6d4f962409880ffeae46009c2daff2d4201cfd91829056c61916e49ee263acfd212c3a6b67a6b651858d4093fa533c1c1c9e37804f5a78f21fa2299fee45663fc856044d2d7477558d70b2147aed12260707befa471d92e97e851ebf8eb1e33d76b53c0f181aafada975972ed60a5c32e620904f06e98957762b3d9b1463fb4581e23f";

      expect(await signerSha512.verifyICAOSignature(signedAttributes, icaoMemberSignature, icaoMemberKey)).to.be.true;
    });
  });
});
